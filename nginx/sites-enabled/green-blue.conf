# Green-Blue deployment configuration
# The active deployment is controlled by the symlink /etc/nginx/sites-enabled/active.conf

upstream frontend_green {
    server front-green:3000 max_fails=3 fail_timeout=30s;
}

upstream frontend_blue {
    server front-blue:3000 max_fails=3 fail_timeout=30s;
}

upstream backend_green {
    server gateway-green:8000 max_fails=3 fail_timeout=30s;
}

upstream backend_blue {
    server gateway-blue:8000 max_fails=3 fail_timeout=30s;
}

# Health check endpoints for monitoring
server {
    listen 8080;
    server_name _;

    location /health/green {
        proxy_pass http://frontend_green/;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        access_log off;
    }

    location /health/blue {
        proxy_pass http://frontend_blue/;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        access_log off;
    }

    location /health/green/api {
        proxy_pass http://backend_green/health;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        access_log off;
    }

    location /health/blue/api {
        proxy_pass http://backend_blue/health;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        access_log off;
    }

    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}